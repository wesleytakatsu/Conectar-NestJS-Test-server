import { NestFactory } from '@nestjs/core';
import { ValidationPipe } from '@nestjs/common';
import { SwaggerModule, DocumentBuilder } from '@nestjs/swagger';
import { AppModule } from './app.module';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);

  // Obter configura√ß√µes do .env
  const port = process.env.PORT || 3000;
  const corsOrigin = process.env.CORS_ORIGIN || 'http://localhost:3000,http://192.168.1.30:3000';
  const debugLogs = process.env.DEBUG_LOGS === 'true';

  // Configurar CORS com origens espec√≠ficas
  const allowedOrigins = corsOrigin.split(',').map(origin => origin.trim());
  
  app.enableCors({
    origin: (origin, callback) => {
      // Em desenvolvimento, permitir qualquer origem localhost ou se origin for undefined (requisi√ß√µes diretas)
      if (!origin || 
          origin.startsWith('http://localhost:') || 
          origin.startsWith('http://127.0.0.1:') ||
          allowedOrigins.includes(origin)) {
        callback(null, true);
      } else {
        callback(new Error('N√£o permitido pelo CORS'), false);
      }
    },
    methods: ['GET', 'POST', 'PUT', 'PATCH', 'DELETE', 'OPTIONS'],
    allowedHeaders: ['Content-Type', 'Authorization', 'Accept', 'Origin', 'X-Requested-With'],
    credentials: true,
  });

  app.useGlobalPipes(new ValidationPipe());

  const config = new DocumentBuilder()
    .setTitle('Conectar API')
    .setDescription(`
# API de Gerenciamento de Usu√°rios - Conectar

Esta API oferece funcionalidades completas para gerenciamento de usu√°rios.

## Como Usar no Swagger

### Passo 1: Fazer Login
1. V√° at√© a se√ß√£o **auth** 
2. Use o endpoint **POST /auth/login**
3. Clique em "Try it out"
4. Use os dados de exemplo j√° preenchidos:
   - **Email**: admin@conectar.com  
   - **Password**: admin123
5. Execute a requisi√ß√£o e copie o **access_token** da resposta

### Passo 2: Autorizar no Swagger
1. Clique no bot√£o **Authorize** üîí (canto superior direito)
2. Cole o token copiado (sem "Bearer", apenas o token)
3. Clique em **Authorize**

### Passo 3: Testar Rotas Protegidas
Agora voc√™ pode testar todas as rotas que precisam de autentica√ß√£o!

## Funcionalidades

- Autentica√ß√£o JWT
- CRUD completo de usu√°rios  
- Filtros e ordena√ß√£o
- Controle de permiss√µes por role
- Usu√°rios inativos (30+ dias sem login)
`)
    .setVersion('1.0')
    .addBearerAuth(
      {
        type: 'http',
        scheme: 'bearer',
        bearerFormat: 'JWT',
        name: 'JWT',
        description: 'Cole aqui o access_token obtido no login (sem "Bearer")',
        in: 'header',
      },
      'JWT-auth',
    )
    .addTag('auth', 'üîë Autentica√ß√£o - Comece aqui! Login para obter token JWT')
    .addTag('users', 'üë• Usu√°rios - Rotas protegidas (requer login)')
    .addServer(`http://localhost:${port}`, 'Servidor de Desenvolvimento')
    .build();
  const document = SwaggerModule.createDocument(app, config);
  SwaggerModule.setup('api', app, document, {
    swaggerOptions: {
      persistAuthorization: true,
      tagsSorter: 'alpha',
      operationsSorter: 'alpha',
    },
    customSiteTitle: 'Conectar API - Documenta√ß√£o',
  });

  await app.listen(port);
  
  console.log(`Servidor rodando em http://localhost:${port}`);
  console.log(`Documenta√ß√£o Swagger: http://localhost:${port}/api`);
  
  if (debugLogs) {
    console.log('\nüîß Para testar no Swagger:');
    console.log('  1. Acesse: http://localhost:' + port + '/api');
    console.log('  2. Fa√ßa login com: admin@conectar.com / admin123');
    console.log('  3. Copie o access_token e clique em Authorize');
    console.log('  4. Teste as rotas protegidas!');
  }
}

bootstrap();
